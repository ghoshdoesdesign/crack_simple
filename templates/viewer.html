<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer with Highlighting, Comments, Notes, and Chatbot</title>
    <script src="{{ url_for('static', filename='pdfjs/pdf.mjs') }}" type="module"></script>
    <style>
        body {
            display: flex;
            justify-content: flex-start;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #pdf-viewer {
            max-width: 800px;
            width: 100%;
            margin: 20px 20px 20px 0;
        }
        .page-container {
            position: relative;
            margin-bottom: 20px;
        }
        .page {
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .highlight-layer {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        .highlight-area {
            position: absolute;
            background-color: rgba(255, 255, 0, 0.3);
            pointer-events: auto;
            cursor: pointer;
        }
        .comment-popup {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .comment-input {
            width: 200px;
            height: 100px;
            margin-bottom: 10px;
        }
        .save-button, .close-button {
            margin-right: 5px;
        }
        .comment-display {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            max-width: 150px;
            word-wrap: break-word;
            z-index: 999;
            pointer-events: none;
        }
        #note-section {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 15px;
            margin-bottom: 20px;
        }
        #note-content {
            width: calc(100% - 20px);
            height: 100px;
            margin-bottom: 10px;
            padding: 5px;
        }
        #save-note-btn {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        #chat-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #chat-content {
            height: 350px;
            overflow-y: auto;
            padding: 10px;
        }
        #chat-input {
            width: calc(100% - 20px);
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div id="pdf-viewer"></div>
    <div id="note-section">
        <textarea id="note-content" placeholder="Write your note here..."></textarea>
        <button id="save-note-btn">Save Note</button>
    </div>
    <div id="chat-box">
        <div id="chat-content">
            <!-- Chat messages will go here -->
        </div>
        <input type="text" id="chat-input" placeholder="Ask something...">
    </div>
    <div id="error-message" style="color: red; text-align: center;"></div>
    <script type="module">
        import * as pdfjsLib from "{{ url_for('static', filename='pdfjs/pdf.mjs') }}";

        pdfjsLib.GlobalWorkerOptions.workerSrc = "{{ url_for('static', filename='pdfjs/pdf.worker.mjs') }}";

        const url = "{{ url_for('uploaded_file', filename=filename) }}";
        const loadingTask = pdfjsLib.getDocument(url);
        const scale = 1.5;
        let pdfDocument = null;
        let allHighlights = {};

        loadingTask.promise.then(function(pdf) {
            pdfDocument = pdf;
            const viewer = document.getElementById('pdf-viewer');

            function renderPage(pageNumber) {
                pdf.getPage(pageNumber).then(function(page) {
                    const viewport = page.getViewport({ scale: scale });

                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'page-container';
                    pageContainer.style.position = 'relative';
                    pageContainer.style.width = `${viewport.width}px`;
                    pageContainer.style.height = `${viewport.height}px`;

                    const canvas = document.createElement('canvas');
                    canvas.className = 'page';
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    const highlightLayer = document.createElement('div');
                    highlightLayer.className = 'highlight-layer';
                    highlightLayer.style.width = `${viewport.width}px`;
                    highlightLayer.style.height = `${viewport.height}px`;

                    pageContainer.appendChild(canvas);
                    pageContainer.appendChild(highlightLayer);
                    viewer.appendChild(pageContainer);

                    page.render(renderContext);

                    setupHighlighting(pageContainer, highlightLayer, page, viewport, pageNumber);

                    if (pageNumber < pdf.numPages) {
                        renderPage(pageNumber + 1);
                    }
                });
            }

            renderPage(1);
        }).catch(function(error) {
            console.error("Error loading PDF:", error);
            document.getElementById('error-message').textContent = "Error loading PDF: " + error.message;
        });

        function setupHighlighting(pageContainer, highlightLayer, page, viewport, pageNumber) {
            let isHighlighting = false;
            let startX, startY;
            allHighlights[pageNumber] = allHighlights[pageNumber] || [];

            pageContainer.addEventListener('mousedown', startHighlighting);
            pageContainer.addEventListener('mousemove', drawHighlight);
            pageContainer.addEventListener('mouseup', endHighlighting);

            function startHighlighting(e) {
                if (e.target.classList.contains('highlight-area')) return;
                isHighlighting = true;
                [startX, startY] = getCoordinates(e);
            }

            function drawHighlight(e) {
                if (!isHighlighting) return;
                const [endX, endY] = getCoordinates(e);
                updateTempHighlight(startX, startY, endX, endY);
            }

            function endHighlighting(e) {
                if (!isHighlighting) return;
                isHighlighting = false;
                const [endX, endY] = getCoordinates(e);

                const highlight = {startX, startY, endX, endY, comment: ''};
                allHighlights[pageNumber].push(highlight);
                drawAllHighlights(highlightLayer, pageNumber);
                showCommentPopup(e, highlight, pageNumber, allHighlights[pageNumber].length - 1);
            }

            function getCoordinates(e) {
                const rect = pageContainer.getBoundingClientRect();
                return [
                    e.clientX - rect.left,
                    e.clientY - rect.top
                ];
            }

            function updateTempHighlight(startX, startY, endX, endY) {
                let tempHighlight = document.getElementById('temp-highlight');
                if (!tempHighlight) {
                    tempHighlight = document.createElement('div');
                    tempHighlight.id = 'temp-highlight';
                    tempHighlight.className = 'highlight-area';
                    highlightLayer.appendChild(tempHighlight);
                }
                tempHighlight.style.left = `${Math.min(startX, endX)}px`;
                tempHighlight.style.top = `${Math.min(startY, endY)}px`;
                tempHighlight.style.width = `${Math.abs(endX - startX)}px`;
                tempHighlight.style.height = `${Math.abs(endY - startY)}px`;
            }
        }

        function drawAllHighlights(highlightLayer, pageNumber) {
            highlightLayer.innerHTML = '';
            if (!allHighlights[pageNumber]) return;
          
            allHighlights[pageNumber].forEach((highlight, index) => {
                const highlightElement = document.createElement('div');
                highlightElement.className = 'highlight-area';
                highlightElement.style.left = `${Math.min(highlight.startX, highlight.endX)}px`;
                highlightElement.style.top = `${Math.min(highlight.startY, highlight.endY)}px`;
                highlightElement.style.width = `${Math.abs(highlight.endX - highlight.startX)}px`;
                highlightElement.style.height = `${Math.abs(highlight.endY - highlight.startY)}px`;
              
                highlightElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showCommentPopup(e, highlight, pageNumber, index);
                });

                highlightLayer.appendChild(highlightElement);

                if (highlight.comment) {
                    const commentDisplay = document.createElement('div');
                    commentDisplay.className = 'comment-display';
                    commentDisplay.textContent = highlight.comment;
                    commentDisplay.style.left = `${Math.max(highlight.startX, highlight.endX)}px`;
                    commentDisplay.style.top = `${Math.min(highlight.startY, highlight.endY)}px`;
                    highlightLayer.appendChild(commentDisplay);
                }
            });
        }

        function showCommentPopup(event, highlight, pageNumber, index) {
            const existingPopup = document.querySelector('.comment-popup');
            if (existingPopup) existingPopup.remove();

            const popup = document.createElement('div');
            popup.className = 'comment-popup';
            popup.style.left = `${event.pageX}px`;
            popup.style.top = `${event.pageY}px`;

            const textarea = document.createElement('textarea');
            textarea.className = 'comment-input';
            textarea.value = highlight.comment || '';
            textarea.placeholder = 'Add a comment...';

            const saveButton = document.createElement('button');
            saveButton.className = 'save-button';
            saveButton.textContent = 'Save';
            saveButton.onclick = () => {
                highlight.comment = textarea.value;
                allHighlights[pageNumber][index] = highlight;
                popup.remove();
                const highlightLayer = event.target.closest('.highlight-layer');
                drawAllHighlights(highlightLayer, pageNumber);

                saveHighlightToServer(filename, pageNumber, highlight);
            };

            const closeButton = document.createElement('button');
            closeButton.className = 'close-button';
            closeButton.textContent = 'Close';
            closeButton.onclick = () => popup.remove();

            popup.appendChild(textarea);
            popup.appendChild(saveButton);
            popup.appendChild(closeButton);
            document.body.appendChild(popup);

            textarea.focus();
        }

        function saveHighlightToServer(filename, pageNumber, highlight) {
            fetch('/save_highlight', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: filename,
                    page_number: pageNumber,
                    highlight: highlight
                }),
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      console.log('Highlight saved successfully');
                  }
              });
        }

        document.getElementById('save-note-btn').addEventListener('click', function() {
            const note = document.getElementById('note-content').value;

            fetch('/save_note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: "{{ filename }}",
                    note: note
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Note saved successfully!');
                    document.getElementById('note-content').value = '';
                }
            });
        });

        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = e.target.value;
                e.target.value = '';
                addChatMessage('You', query);

                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: "{{ filename }}",
                        query: query
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.response) {
                        addChatMessage('Bot', data.response);
                    }
                });
            }
        });

        function addChatMessage(sender, message) {
            const chatContent = document.getElementById('chat-content');
            const messageElement = document.createElement('div');
            messageElement.textContent = `${sender}: ${message}`;
            chatContent.appendChild(messageElement);
            chatContent.scrollTop = chatContent.scrollHeight;
        }
    </script>
</body>
</html>
